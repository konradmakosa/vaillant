<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wanna">
    <meta name="theme-color" content="#0a1628">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Wanna</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            width: 100%; height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: #1a1a2e;
            color: #fff;
            -webkit-user-select: none;
            user-select: none;
        }

        /* ── Layer 1: Video background — full brightness ── */
        .bg-video {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 0;
        }

        /* ── Layer 1.5: Easter egg GIF overlay ── */
        .egg-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 0;
            pointer-events: none;
            opacity: 0;
        }

        .egg-overlay.visible {
            opacity: 1;
        }

        /* ── Layer 2: Subtle steam particles ── */
        .particle {
            position: fixed;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.12), transparent 70%);
            z-index: 1;
            pointer-events: none;
            animation: float linear infinite;
        }

        @keyframes float {
            0%   { transform: translateY(0) scale(1); opacity: 0; }
            10%  { opacity: 0.8; }
            90%  { opacity: 0.8; }
            100% { transform: translateY(-100vh) scale(0.3); opacity: 0; }
        }

        /* ── Layer 3: Temperature circles ── */
        .temp-circle {
            position: fixed;
            z-index: 2;
            width: 72px;
            height: 72px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.2s;
        }

        .temp-circle:active {
            transform: scale(0.9);
        }

        .circle-water  { animation: drift1 8s ease-in-out infinite alternate; }
        .circle-room    { animation: drift2 10s ease-in-out infinite alternate; }
        .circle-outdoor { animation: drift3 9s ease-in-out infinite alternate; }

        @keyframes drift1 {
            0%   { transform: translate(0, 0); }
            33%  { transform: translate(8px, -6px); }
            66%  { transform: translate(-5px, 10px); }
            100% { transform: translate(7px, 5px); }
        }

        @keyframes drift2 {
            0%   { transform: translate(0, 0); }
            33%  { transform: translate(-7px, 8px); }
            66%  { transform: translate(9px, -4px); }
            100% { transform: translate(-6px, -7px); }
        }

        @keyframes drift3 {
            0%   { transform: translate(0, 0); }
            33%  { transform: translate(6px, 7px); }
            66%  { transform: translate(-8px, -5px); }
            100% { transform: translate(4px, -9px); }
        }

        .temp-circle .val {
            font-size: 30px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .temp-circle .val .unit {
            font-size: 16px;
            font-weight: 400;
            opacity: 0.7;
            vertical-align: super;
            line-height: 0;
        }

        /* Water — blue, on the bath */
        .circle-water {
            left: 13%;
            top: 64%;
            background: rgba(66, 165, 245, 0.6);
            border-color: rgba(66, 165, 245, 0.5);
        }
        .circle-water .val { color: #fff; }

        /* Room — yellow, on the ceiling */
        .circle-room {
            left: 19%;
            top: 24%;
            background: rgba(255, 213, 79, 0.6);
            border-color: rgba(255, 213, 79, 0.5);
        }
        .circle-room .val { color: #fff; }

        /* Outdoor — green, on the window */
        .circle-outdoor {
            left: 47%;
            top: 13%;
            background: rgba(129, 199, 132, 0.6);
            border-color: rgba(129, 199, 132, 0.5);
        }
        .circle-outdoor .val { color: #fff; }

        /* ── Layer 4: Boost button — bottom right ── */
        .boost-btn {
            position: fixed;
            z-index: 3;
            bottom: 40px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 2px solid rgba(255, 107, 157, 0.4);
            background: rgba(255, 107, 157, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: #ff6b9d;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .boost-btn:active {
            transform: scale(0.85);
            background: rgba(255, 107, 157, 0.35);
        }

        .boost-btn.active {
            border-color: rgba(255, 213, 79, 0.8);
            background: rgba(255, 213, 79, 0.35);
            color: #ffd54f;
            animation: pulse 2s ease-in-out infinite;
        }

        .boost-btn.loading {
            pointer-events: none;
            opacity: 0.5;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 213, 79, 0.4); }
            50%      { box-shadow: 0 0 0 14px rgba(255, 213, 79, 0); }
        }

        .boost-status {
            position: fixed;
            z-index: 3;
            bottom: 110px;
            right: 12px;
            font-size: 10px;
            color: rgba(255, 213, 79, 0.9);
            text-align: center;
            width: 88px;
        }

        /* Safe area for notch/home indicator */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .boost-btn {
                bottom: calc(40px + env(safe-area-inset-bottom));
            }
            .boost-status {
                bottom: calc(110px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>

<!-- Layer 1: Video background -->
<video class="bg-video" autoplay muted loop playsinline>
    <source src="wanna_background.mp4" type="video/mp4">
</video>

<!-- Layer 1.5: Easter egg overlay -->
<img class="egg-overlay" id="egg-overlay" alt="">

<!-- Layer 3: Temperature circles -->
<div class="temp-circle circle-water" id="c-water">
    <div class="val" id="v-dhw">—</div>
</div>
<div class="temp-circle circle-room" id="c-room">
    <div class="val" id="v-room">—</div>
</div>
<div class="temp-circle circle-outdoor" id="c-outdoor">
    <div class="val" id="v-outdoor">—</div>
</div>

<!-- Layer 4: Boost button -->
<button class="boost-btn" id="boost-btn" onclick="toggleBoost()">♨️</button>
<div class="boost-status" id="boost-status"></div>

<script>
// ── Config ──
const REPO_OWNER = 'konradmakosa';
const REPO_NAME = 'vaillant';
const WORKER_URL = 'https://vaillant-trigger.konrad-makosa.workers.dev';

// ── Steam particles ──
function createParticles() {
    for (let i = 0; i < 15; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        const size = 20 + Math.random() * 60;
        p.style.width = size + 'px';
        p.style.height = size + 'px';
        p.style.left = (Math.random() * 100) + '%';
        p.style.bottom = '-' + size + 'px';
        p.style.animationDuration = (8 + Math.random() * 12) + 's';
        p.style.animationDelay = (Math.random() * 10) + 's';
        document.body.appendChild(p);
    }
}
createParticles();

// ── Data loading ──
function getCSVUrl() {
    const now = new Date();
    const y = now.getUTCFullYear();
    const m = String(now.getUTCMonth() + 1).padStart(2, '0');
    return `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/data/boiler_${y}-${m}.csv`;
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return null;
    const headers = lines[0].split(',');
    const last = lines[lines.length - 1].split(',');
    const row = {};
    headers.forEach((h, i) => { row[h.trim()] = (last[i] || '').trim(); });
    return row;
}

function setCircle(id, val, unit) {
    const el = document.getElementById(id);
    if (!el) return;
    const n = parseFloat(val);
    if (isNaN(n) || val === '' || val === 'None') {
        el.textContent = '—';
    } else {
        el.innerHTML = n.toFixed(1) + '<span class="unit">' + unit + '</span>';
    }
}

async function loadData() {
    try {
        const resp = await fetch(getCSVUrl(), { cache: 'no-store' });
        if (!resp.ok) return;
        const text = await resp.text();
        const row = parseCSV(text);
        if (!row) return;

        setCircle('v-dhw', row.dhw_current_temp_c, '°');
        setCircle('v-room', row.zone_current_temp_c, '°');
        setCircle('v-outdoor', row.outdoor_temp_c, '°');
    } catch (e) {
        console.error('Data load error:', e);
    }
}

// ── Boost ──
const BOOST_LOCK_MS = 30 * 60 * 1000; // 30 minutes
let boostTimer = null;

function getBoostExpiry() {
    const v = localStorage.getItem('boost_expiry');
    return v ? parseInt(v) : 0;
}

function setBoostExpiry(ts) {
    localStorage.setItem('boost_expiry', String(ts));
}

function updateBoostUI() {
    const btn = document.getElementById('boost-btn');
    const status = document.getElementById('boost-status');
    const remaining = getBoostExpiry() - Date.now();

    if (remaining > 0) {
        btn.classList.add('active');
        btn.classList.add('loading');
        if (!boostTimer) {
            boostTimer = setTimeout(() => {
                btn.classList.remove('active');
                btn.classList.remove('loading');
                boostTimer = null;
            }, remaining);
        }
    } else {
        btn.classList.remove('active');
        btn.classList.remove('loading');
    }
}

async function toggleBoost() {
    const btn = document.getElementById('boost-btn');
    const status = document.getElementById('boost-status');

    if (getBoostExpiry() > Date.now()) return; // locked

    btn.classList.add('loading');
    status.textContent = 'Wysyłam...';

    try {
        const resp = await fetch(WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'boost-dhw' }),
        });
        const data = await resp.json();

        if (data.status === 'triggered') {
            setBoostExpiry(Date.now() + BOOST_LOCK_MS);
            updateBoostUI();
        } else if (data.status === 'cooldown') {
            status.textContent = `Poczekaj ${data.retry_in}s`;
            btn.classList.remove('loading');
            setTimeout(() => { status.textContent = ''; }, 5000);
        } else {
            status.textContent = 'Błąd';
            btn.classList.remove('loading');
            setTimeout(() => { status.textContent = ''; }, 5000);
        }
    } catch (e) {
        status.textContent = 'Brak połączenia';
        btn.classList.remove('loading');
        setTimeout(() => { status.textContent = ''; }, 5000);
    }
}

// Restore boost state on load
updateBoostUI();

// ── Service Worker ──
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// ── Easter eggs ──
const EGG_COUNT = 20; // max files to check (1.webp .. n.webp)
const EGG_INTERVAL = 30000; // 30s between swaps
const EGG_DISPLAY = 0; // 0 = show full duration of GIF cycle
let knownEggs = [];

async function discoverEggs() {
    for (let i = 1; i <= EGG_COUNT; i++) {
        try {
            const resp = await fetch(`eggs/${i}.webp`, { method: 'HEAD' });
            const ct = resp.headers.get('content-type') || '';
            if (resp.ok && ct.includes('image')) knownEggs.push(`eggs/${i}.webp`);
        } catch (_) {}
    }
    console.log(`Easter eggs found: ${knownEggs.length}`);
}

function tryShowEgg() {
    if (knownEggs.length === 0) return;
    const overlay = document.getElementById('egg-overlay');
    // probability: 1 egg = 50%, 2 eggs = 33%, 3 eggs = 25% ...
    if (Math.random() > 1 / (knownEggs.length + 1)) return;
    const src = knownEggs[Math.floor(Math.random() * knownEggs.length)];
    overlay.src = src;
    overlay.classList.add('visible');
    setTimeout(() => {
        overlay.classList.remove('visible');
        overlay.removeAttribute('src');
    }, 5000);
}

setInterval(tryShowEgg, EGG_INTERVAL);

// ── Init ──
loadData();
setInterval(loadData, 60000);
discoverEggs();
</script>

</body>
</html>
